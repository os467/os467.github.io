<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ElasticSearch | Tly的博客</title>
  <meta name="keywords" content="">
  <meta name="description" content="ElasticSearch | Tly的博客">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="window.onload &#x3D; function(){          location.href&#x3D;&quot;https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV17h411k7jB?vd_source&#x3D;38c37e7cf61f2c4591c73b0a37eab964&quot;      }       	---不要点开这个链接---">
<meta property="og:type" content="website">
<meta property="og:title" content="Tly的博客">
<meta property="og:url" content="https://os467.github.io/about/index.html">
<meta property="og:site_name" content="Tly的博客">
<meta property="og:description" content="window.onload &#x3D; function(){          location.href&#x3D;&quot;https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV17h411k7jB?vd_source&#x3D;38c37e7cf61f2c4591c73b0a37eab964&quot;      }       	---不要点开这个链接---">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-09-05T07:48:23.998Z">
<meta property="article:modified_time" content="2022-09-05T07:48:23.998Z">
<meta property="article:author" content="Os467">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/headimg.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 6.2.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/headimg.jpg"/>
</a>
<div class="author">
    <span>Os467</span>
</div>

<div class="icon">
    
        
            <a title="rss"
               href="/atom.xml"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-rss"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="github"
               href="https://github.com/os467"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            <a title="email"
               href="mailto:1300452403@qq.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="qq"
               href="http://wpa.qq.com/msgrd?v=3&uin=1300452403&site=qq&menu=yes"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-qq"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="kugou"
               href="https://www.kugou.com/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-kugou"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="neteasemusic"
               href="https://music.163.com/song?id=551339076&amp;userid=1571495855"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-neteasemusic"></use>
                    </svg>
                
            </a>
        
    
</div>




<ul>
    <li>
        <div class="all active" data-rel="全部文章">全部文章
            
                <small>(43)</small>
            
        </div>
    </li>
    
        
            
                <li>
                    <div data-rel="JAVASE基础">
                        
                        JAVASE基础
                        <small>(9)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="JAVASE进阶">
                        
                        JAVASE进阶
                        <small>(6)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="框架学习">
                        
                        框架学习
                        <small>(10)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="微服务">
                        
                        微服务
                        <small>(6)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="运维">
                        
                        运维
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="项目">
                        
                        项目
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="底层学习">
                        
                        底层学习
                        <small>(4)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="前端">
                        
                        前端
                        <small>(2)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="其它">
                        
                        其它
                        <small>(2)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="数据库">
                        
                        数据库
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
</ul>
<div class="music-player" style="width: 100px;height: 66px;">
    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100 height=66 src="//music.163.com/outchain/player?type=2&id=1919435807&auto=1&height=66"></iframe>
</div>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">关于</a>
        
        <a style="width: 50%"
                
                                           class="friends">友链</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="43">
<input type="hidden" id="yelog_site_word_count" value="189.6k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://os467.github.io/mdResource">os467</a></li>
            
            <li><a target="_blank" href="https://www.bilibili.com/video/BV17h411k7jB?vd_source=38c37e7cf61f2c4591c73b0a37eab964">这是一个神奇的链接</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        
        <a  class="全部文章 框架学习 "
           href="/2022/09/19/SpringSecurity/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="SpringSecurity">SpringSecurity</span>
            <span class="post-date" title="2022-09-19 23:33:22">2022/09/19</span>
        </a>
        
        
        <a  class="全部文章 数据库 "
           href="/2022/09/16/Mysql%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Mysql事务隔离级别">Mysql事务隔离级别</span>
            <span class="post-date" title="2022-09-16 19:51:23">2022/09/16</span>
        </a>
        
        
        <a  class="全部文章 底层学习 "
           href="/2022/09/15/ThreadLocal/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="ThreadLocal">ThreadLocal</span>
            <span class="post-date" title="2022-09-15 00:02:03">2022/09/15</span>
        </a>
        
        
        <a  class="全部文章 其它 "
           href="/2022/09/11/%E6%A0%91%E7%BB%93%E6%9E%84%E5%85%A5%E9%97%A8-md/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="树结构入门.md">树结构入门.md</span>
            <span class="post-date" title="2022-09-11 02:27:07">2022/09/11</span>
        </a>
        
        
        <a  class="全部文章 前端 "
           href="/2022/09/08/NodeJS/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="NodeJS">NodeJS</span>
            <span class="post-date" title="2022-09-08 20:18:43">2022/09/08</span>
        </a>
        
        
        <a  class="全部文章 前端 "
           href="/2022/09/08/%E5%89%8D%E7%AB%AF%E5%85%A5%E9%97%A8/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="前端入门">前端入门</span>
            <span class="post-date" title="2022-09-08 10:21:00">2022/09/08</span>
        </a>
        
        
        <a  class="全部文章 底层学习 "
           href="/2022/09/06/Java%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Java对象创建">Java对象创建</span>
            <span class="post-date" title="2022-09-06 21:16:42">2022/09/06</span>
        </a>
        
        
        <a  class="全部文章 微服务 "
           href="/2022/09/04/ElasticSearch/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="ElasticSearch">ElasticSearch</span>
            <span class="post-date" title="2022-09-04 23:29:31">2022/09/04</span>
        </a>
        
        
        <a  class="全部文章 微服务 "
           href="/2022/09/01/springCloud%E9%A1%B9%E7%9B%AE/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="SpringCloud项目搭建">SpringCloud项目搭建</span>
            <span class="post-date" title="2022-09-01 22:23:21">2022/09/01</span>
        </a>
        
        
        <a  class="全部文章 微服务 "
           href="/2022/08/30/RabbitMQ/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="RabbitMQ">RabbitMQ</span>
            <span class="post-date" title="2022-08-30 20:25:33">2022/08/30</span>
        </a>
        
        
        <a  class="全部文章 其它 "
           href="/2022/08/29/MVC%E8%AE%BF%E9%97%AE%E5%A4%9A%E7%BA%BF%E7%A8%8B%E9%97%AE%E9%A2%98/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="MVC多线程安全问题">MVC多线程安全问题</span>
            <span class="post-date" title="2022-08-29 17:18:53">2022/08/29</span>
        </a>
        
        
        <a  class="全部文章 底层学习 "
           href="/2022/08/27/JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="JVM类加载机制">JVM类加载机制</span>
            <span class="post-date" title="2022-08-27 18:10:23">2022/08/27</span>
        </a>
        
        
        <a  class="全部文章 底层学习 "
           href="/2022/08/24/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="JVM虚拟机">JVM虚拟机</span>
            <span class="post-date" title="2022-08-24 18:28:03">2022/08/24</span>
        </a>
        
        
        <a  class="全部文章 运维 "
           href="/2022/08/23/Docker/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Docker">Docker</span>
            <span class="post-date" title="2022-08-23 13:25:11">2022/08/23</span>
        </a>
        
        
        <a  class="全部文章 微服务 "
           href="/2022/08/18/springCloud/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="SpringCloud">SpringCloud</span>
            <span class="post-date" title="2022-08-18 13:21:39">2022/08/18</span>
        </a>
        
        
        <a  class="全部文章 微服务 "
           href="/2022/08/15/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="微服务入门">微服务入门</span>
            <span class="post-date" title="2022-08-15 15:44:35">2022/08/15</span>
        </a>
        
        
        <a  class="全部文章 微服务 "
           href="/2022/08/15/dubbo/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="dubbo">dubbo</span>
            <span class="post-date" title="2022-08-15 07:25:45">2022/08/15</span>
        </a>
        
        
        <a  class="全部文章 框架学习 "
           href="/2022/08/13/redis/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Redis">Redis</span>
            <span class="post-date" title="2022-08-13 14:25:31">2022/08/13</span>
        </a>
        
        
        <a  class="全部文章 框架学习 "
           href="/2022/08/12/bootstrap/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Bootstrap(WEB框架)">Bootstrap(WEB框架)</span>
            <span class="post-date" title="2022-08-12 16:23:21">2022/08/12</span>
        </a>
        
        
        <a  class="全部文章 框架学习 "
           href="/2022/08/12/springboot/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="SpringBoot">SpringBoot</span>
            <span class="post-date" title="2022-08-12 12:15:35">2022/08/12</span>
        </a>
        
        
        <a  class="全部文章 框架学习 "
           href="/2022/08/08/ssm%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="SSM项目整合">SSM项目整合</span>
            <span class="post-date" title="2022-08-08 12:15:25">2022/08/08</span>
        </a>
        
        
        <a  class="全部文章 项目 "
           href="/2022/08/03/%E5%A4%96%E5%8D%96%E9%A1%B9%E7%9B%AE/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="外卖项目">外卖项目</span>
            <span class="post-date" title="2022-08-03 08:35:11">2022/08/03</span>
        </a>
        
        
        <a  class="全部文章 框架学习 "
           href="/2022/08/01/MyBatisPlus/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="MyBatisPlus">MyBatisPlus</span>
            <span class="post-date" title="2022-08-01 11:15:26">2022/08/01</span>
        </a>
        
        
        <a  class="全部文章 框架学习 "
           href="/2022/07/31/MyBatis/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="MyBatis">MyBatis</span>
            <span class="post-date" title="2022-07-31 10:10:26">2022/07/31</span>
        </a>
        
        
        <a  class="全部文章 框架学习 "
           href="/2022/07/28/Maven/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Maven">Maven</span>
            <span class="post-date" title="2022-07-28 19:10:41">2022/07/28</span>
        </a>
        
        
        <a  class="全部文章 框架学习 "
           href="/2022/07/26/spring/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="spring">spring</span>
            <span class="post-date" title="2022-07-26 21:54:22">2022/07/26</span>
        </a>
        
        
        <a  class="全部文章 框架学习 "
           href="/2022/07/23/springMVC/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="SpringMVC">SpringMVC</span>
            <span class="post-date" title="2022-07-23 21:35:21">2022/07/23</span>
        </a>
        
        
        <a  class="全部文章 JAVASE进阶 "
           href="/2022/07/18/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="设计模式">设计模式</span>
            <span class="post-date" title="2022-07-18 19:21:50">2022/07/18</span>
        </a>
        
        
        <a  class="全部文章 JAVASE基础 "
           href="/2022/07/17/Ajax/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Ajax">Ajax</span>
            <span class="post-date" title="2022-07-17 12:07:22">2022/07/17</span>
        </a>
        
        
        <a  class="全部文章 JAVASE进阶 "
           href="/2022/07/14/Annotation/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Annotation">Annotation</span>
            <span class="post-date" title="2022-07-14 19:36:02">2022/07/14</span>
        </a>
        
        
        <a  class="全部文章 JAVASE进阶 "
           href="/2022/07/14/%E6%B3%A8%E8%A7%A3Annotation/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="注解">注解</span>
            <span class="post-date" title="2022-07-14 10:09:18">2022/07/14</span>
        </a>
        
        
        <a  class="全部文章 JAVASE进阶 "
           href="/2022/07/13/Reflect/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Reflect">Reflect</span>
            <span class="post-date" title="2022-07-13 14:40:18">2022/07/13</span>
        </a>
        
        
        <a  class="全部文章 JAVASE进阶 "
           href="/2022/07/12/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="多线程">多线程</span>
            <span class="post-date" title="2022-07-12 12:29:58">2022/07/12</span>
        </a>
        
        
        <a  class="全部文章 JAVASE进阶 "
           href="/2022/07/10/IO%E6%B5%81/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="IO流">IO流</span>
            <span class="post-date" title="2022-07-10 20:14:33">2022/07/10</span>
        </a>
        
        
        <a  class="全部文章 JAVASE基础 "
           href="/2022/07/08/jQuery/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="jQuery">jQuery</span>
            <span class="post-date" title="2022-07-08 16:24:33">2022/07/08</span>
        </a>
        
        
        <a  class="全部文章 JAVASE基础 "
           href="/2022/07/07/javaScript/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="javaScript">javaScript</span>
            <span class="post-date" title="2022-07-07 12:54:16">2022/07/07</span>
        </a>
        
        
        <a  class="全部文章 JAVASE基础 "
           href="/2022/07/06/XML/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="XML">XML</span>
            <span class="post-date" title="2022-07-06 18:28:03">2022/07/06</span>
        </a>
        
        
        <a  class="全部文章 JAVASE基础 "
           href="/2022/07/06/cookie%E5%92%8Csession/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="cookie和session">cookie和session</span>
            <span class="post-date" title="2022-07-06 18:27:45">2022/07/06</span>
        </a>
        
        
        <a  class="全部文章 JAVASE基础 "
           href="/2022/07/02/servlet/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="servlet">servlet</span>
            <span class="post-date" title="2022-07-02 08:24:49">2022/07/02</span>
        </a>
        
        
        <a  class="全部文章 JAVASE基础 "
           href="/2022/07/01/jdbc/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="jdbc">jdbc</span>
            <span class="post-date" title="2022-07-01 08:24:49">2022/07/01</span>
        </a>
        
        
        <a  class="全部文章 JAVASE基础 "
           href="/2022/06/19/SQL/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="SQL">SQL</span>
            <span class="post-date" title="2022-06-19 19:45:07">2022/06/19</span>
        </a>
        
        
        <a  class="全部文章 JAVASE基础 "
           href="/2022/05/28/JAVA%E5%85%A5%E9%97%A8/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="JAVA入门">JAVA入门</span>
            <span class="post-date" title="2022-05-28 00:32:07">2022/05/28</span>
        </a>
        
        
        <a  class="全部文章 "
           href="/2022/05/27/Linux%E4%BA%91%E8%AE%A1%E7%AE%97/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Linux云计算">Linux云计算</span>
            <span class="post-date" title="2022-05-27 00:05:15">2022/05/27</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-ElasticSearch" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">ElasticSearch</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="微服务">微服务</a>
            
        </span>
        
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2022-09-15 00:00:36'>2022-09-04 23:29</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:8.6k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2ES"><span class="toc-text">分布式搜索ES</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Elastic-Search%E7%AE%80%E4%BB%8B"><span class="toc-text">Elastic Search简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-text">倒排索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%A1%A3"><span class="toc-text">文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%EF%BC%88Index%EF%BC%89"><span class="toc-text">索引（Index）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E5%AF%B9%E6%AF%94"><span class="toc-text">概念对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85ES"><span class="toc-text">安装ES</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2Kibana"><span class="toc-text">部署Kibana</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text">分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IK%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text">IK分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text">安装分词器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E5%85%B8%E4%B8%AA%E6%80%A7%E5%8C%96%E8%AE%BE%E7%BD%AE"><span class="toc-text">字典个性化设置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DSL-%E7%B4%A2%E5%BC%95%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-text">DSL-索引库操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mapping%E5%B1%9E%E6%80%A7"><span class="toc-text">mapping属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-text">创建索引库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E3%80%81%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-text">查询、删除索引库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-text">修改索引库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DSL-%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-text">DSL-文档操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E6%96%87%E6%A1%A3"><span class="toc-text">新增文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-text">查询文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-text">删除文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3"><span class="toc-text">修改文档</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RestClient%E6%93%8D%E4%BD%9C%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-text">RestClient操作索引库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96JavaRestClient"><span class="toc-text">初始化JavaRestClient</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Java%E7%B4%A2%E5%BC%95%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-text">Java索引库操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93-1"><span class="toc-text">创建索引库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="toc-text">删除索引库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E7%B4%A2%E5%BC%95%E5%BA%93%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-text">判断索引库是否存在</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Java%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-text">Java文档操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E6%96%87%E6%A1%A3"><span class="toc-text">添加新的文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE"><span class="toc-text">查询文档数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE"><span class="toc-text">更新文档数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE"><span class="toc-text">删除文档数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Bulk%E6%89%B9%E9%87%8F%E5%A4%84%E7%90%86"><span class="toc-text">Bulk批量处理</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ES%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD"><span class="toc-text">ES搜索功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DSL-%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-text">DSL-查询文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E6%9F%A5%E8%AF%A2"><span class="toc-text">全文检索查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2"><span class="toc-text">精确查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%B0%E7%90%86%E6%9F%A5%E8%AF%A2"><span class="toc-text">地理查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-text">复合查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E5%A4%84%E7%90%86"><span class="toc-text">搜索结果处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F"><span class="toc-text">排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5"><span class="toc-text">分页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE"><span class="toc-text">高亮</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RestClient%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-text">RestClient查询文档</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E6%9F%A5%E8%AF%A2-1"><span class="toc-text">全文检索查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B2%BE%E7%A1%AE%E6%9F%A5%E8%AF%A2-1"><span class="toc-text">精确查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2-boolean-query"><span class="toc-text">复合查询-boolean query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E5%92%8C%E5%88%86%E9%A1%B5"><span class="toc-text">排序和分页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE%E6%98%BE%E7%A4%BA"><span class="toc-text">高亮显示</span></a></li></ol></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="分布式搜索ES"><a href="#分布式搜索ES" class="headerlink" title="分布式搜索ES"></a>分布式搜索ES</h1><h2 id="Elastic-Search简介"><a href="#Elastic-Search简介" class="headerlink" title="Elastic Search简介"></a>Elastic Search简介</h2><p><strong>什么是elasticsearch？</strong></p>
<p>elasticsearch是一款非常强大的开源搜索引擎，可以帮助我们从海量数据中快速找到需要的内容</p>
<p>elasticsearch结合kibana、Logstash、Beats，也就是<strong>elastic stack（ELK）</strong>，被广泛应用在日志数据分析、实时监控等领域</p>
<p><strong>数据可视化</strong></p>
<ul>
<li>Kibana</li>
</ul>
<p><strong>存储、搜索、分析数据</strong></p>
<ul>
<li>elasticsearch是elastic stack的核心</li>
</ul>
<p><strong>数据抓取</strong></p>
<ul>
<li>Logstash、Beats</li>
</ul>
<p><strong>ElasticSearch的底层是Lucene技术（apache组织提供）</strong></p>
<ul>
<li>Lucene是一个Java语言的搜索引擎类库，是Apache公司的顶级项目，由DougCutting于1999年研发，官网：<a target="_blank" rel="noopener" href="https://lucene.apache.org/">https://lucene.apache.org/</a></li>
<li>Lucene的优势：易扩展，高性能（基于倒排索引）</li>
<li>Lucene的缺点：只限于Java语言开发，学习曲线陡峭，不支持水平扩展</li>
</ul>
<p><strong>Elastic Search的发展</strong></p>
<p>2004年Shay Banon基于Lucene开发了Compass</p>
<p>2010年Shay Banon重写了Compass，取名为Elasticsearch</p>
<p>官网地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/">https://www.elastic.co/cn/</a></p>
<p>官方教程：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/index.html">https://www.elastic.co/guide/cn/index.html</a></p>
<p>相比与Lucene，elasticsearch具备下列优势</p>
<ul>
<li>支持分布式，可水平扩展</li>
<li>提供Restful接口，可被任何语言调用</li>
</ul>
<p>较热门的搜索引擎技术：</p>
<ul>
<li>Elasticsearch 开源的分布式搜索引擎</li>
<li>Splunk 商业项目</li>
<li>Solr Apache的开源搜索引擎</li>
</ul>
<h2 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h2><p><strong>正向索引和倒排索引</strong></p>
<p><strong>正向索引</strong>（根据文档找到词）</p>
<p>传统数据库（如mysql）采用正向索引，例如给下表（tb_goods）中的id创建索引：</p>
<table>
<thead>
<tr>
<th align="center">id</th>
<th align="center">title</th>
<th align="center">price</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">小米手机</td>
<td align="center">3499</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">华为手机</td>
<td align="center">4999</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">华为小米充电器</td>
<td align="center">49</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">小米手环</td>
<td align="center">49</td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
</tr>
</tbody></table>
<p>搜索 <code>手机</code></p>
<p><code>select * from tb_goods where title like &#39;%手机%&#39;</code></p>
<p>逐条数据扫描，判断是否包含<code>手机</code>，如果包含则存入结果集中</p>
<p><strong>倒排索引</strong>（根据词找文档）</p>
<table>
<thead>
<tr>
<th align="center">词条（term）</th>
<th align="center">文档id</th>
</tr>
</thead>
<tbody><tr>
<td align="center">小米</td>
<td align="center">1，3，4</td>
</tr>
<tr>
<td align="center">手机</td>
<td align="center">1，2</td>
</tr>
<tr>
<td align="center">华为</td>
<td align="center">2，3</td>
</tr>
<tr>
<td align="center">充电器</td>
<td align="center">3</td>
</tr>
<tr>
<td align="center">手环</td>
<td align="center">4</td>
</tr>
</tbody></table>
<p>elasticsearch采用倒排索引</p>
<ul>
<li>文档（document）：<strong>每条数据就是一个文档</strong></li>
<li>词条（term）：文档<strong>按照语义分成的词语</strong>   （词条不会重复创建，具有唯一性）</li>
</ul>
<p>使用倒排索引搜索<code>华为手机</code></p>
<ol>
<li><p>分词，得到<code>华为</code>，<code>手机</code>两个词条</p>
</li>
<li><p><strong>根据词条去词条列表查询文档id</strong></p>
</li>
<li><p>得到每个词条所在文档id：</p>
<p>华为：2，3</p>
<p>手机：1，2</p>
</li>
<li><p><strong>根据文档id查询文档</strong>，得到id为1，2，3的文档，存入结果集中（2的关联度较高会放在前面）</p>
</li>
</ol>
<h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><p>elasticsearch是面向文档存储的，可以是数据库中的一条商品数据，一个订单信息</p>
<p>文档数据会被序列化为JSON格式后存储在elasticsearch中</p>
<h3 id="索引（Index）"><a href="#索引（Index）" class="headerlink" title="索引（Index）"></a>索引（Index）</h3><p>相同类型的<strong>文档的集合</strong>，如商品索引，用户索引，订单索引（类似数据库表的概念）</p>
<p><strong>映射（mapping）</strong>：索引中文档的<strong>字段约束信息</strong>，类似表的结构约束</p>
<h2 id="概念对比"><a href="#概念对比" class="headerlink" title="概念对比"></a>概念对比</h2><table>
<thead>
<tr>
<th><strong>MySQL</strong></th>
<th><strong>Elasticsearch</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Table</td>
<td>Index</td>
<td>索引(index)，就是文档的集合，类似数据库的表(table)</td>
</tr>
<tr>
<td>Row</td>
<td>Document</td>
<td>文档（Document），就是一条条的数据，类似数据库中的行（Row），文档都是JSON格式</td>
</tr>
<tr>
<td>Column</td>
<td>Field</td>
<td>字段（Field），就是JSON文档中的字段，类似数据库中的列（Column）</td>
</tr>
<tr>
<td>Schema</td>
<td>Mapping</td>
<td>Mapping（映射）是索引中文档的约束，例如字段类型约束，类似数据库的表结构（Schema）</td>
</tr>
<tr>
<td>SQL</td>
<td>DSL</td>
<td>DSL是elasticsearch提供的JSON风格的请求语句，用来操作elasticsearch，实现CRUD</td>
</tr>
</tbody></table>
<p><strong>架构对比</strong></p>
<ul>
<li>Mysql：擅长事务类型操作，可以确保数据的安全和一致性（ACID原则）</li>
<li>Elasticsearch：擅长海量数据的搜索，分析，计算</li>
</ul>
<p>ES承担了搜索操作，Mysql承担了写操作，mysql可以将数据同步到ES中（起到了互补的效果）</p>
<h2 id="安装ES"><a href="#安装ES" class="headerlink" title="安装ES"></a>安装ES</h2><p><strong>部署单点es</strong></p>
<p>1、创建网络</p>
<p>因为我们还要部署kibana容器，因此需要让es和kibana容器互联，这里先创建一个网络：</p>
<pre><code class="bash">docker network create es-net
</code></pre>
<p>2、加载镜像</p>
<p>这里我们采用elasticsearch的1.12.1版本的镜像，这个镜像体积非常大，接近1G，不建议自己pull</p>
<p>使用镜像tar包，上传到虚拟机使用命令加载即可</p>
<pre><code class="bash">docker load -i es.tar
</code></pre>
<p>同理kibana的tar包也是如此</p>
<p>3、运行</p>
<p>运行docker命令，部署单点es：</p>
<p>-e参数说明</p>
<ul>
<li>配置JVM内存大小（es由java实现）</li>
<li>配置运行模式</li>
</ul>
<p>-v参数说明</p>
<ul>
<li>数据保存挂载目录</li>
<li>插件拓展目录</li>
</ul>
<p><code>--network</code> ： 加入网络</p>
<p><code>--privileged</code>：授予逻辑卷访问权</p>
<p>-p参数说明</p>
<p>9200端口：http端口，提供用户访问</p>
<p>9300端口：容器之间各个节点互联端口</p>
<pre><code class="bash">docker run -d \
    --name es \
    -e &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot; \
    -e &quot;discovery.type=single-node&quot; \
    -v es-data:/usr/share/elasticsearch/data \
    -v es-plugins:/usr/share/elasticsearch/plugins \
    --privileged \
    --network es-net \
    -p 9200:9200 \
    -p 9300:9300 \
elasticsearch:7.12.1
</code></pre>
<p>输入<code>192.168.119.88:9200</code>查看访问结果</p>
<h2 id="部署Kibana"><a href="#部署Kibana" class="headerlink" title="部署Kibana"></a>部署Kibana</h2><pre><code class="bash">docker run -d \
--name kibana \
-e ELASTICSEARCH_HOSTS=http://es:9200 \
--network=es-net \
-p 5601:5601  \
kibana:7.12.1
</code></pre>
<ul>
<li><code>--network es-net</code> ：加入一个名为es-net的网络中，与elasticsearch在同一个网络中</li>
<li><code>-e ELASTICSEARCH_HOSTS=http://es:9200&quot;</code>：设置elasticsearch的地址，因为kibana已经与elasticsearch在一个网络，因此可以用容器名直接访问elasticsearch</li>
<li><code>-p 5601:5601</code>：端口映射配置</li>
</ul>
<blockquote>
<p>kibana版本需要和es版本保持一致</p>
</blockquote>
<p>浏览器访问<code>192.168.119.88:5601</code>查看图形化界面</p>
<p>使用Kibana提供的<strong>Dev Tools</strong>来发送DSL语句（本质上就是发送一个RESTFUL的请求到es当中）</p>
<p><strong>测试es是否连接</strong></p>
<pre><code class="json">GET /
</code></pre>
<h2 id="分词器"><a href="#分词器" class="headerlink" title="分词器"></a>分词器</h2><p>es在创建倒排索引时需要对文档分词，在搜索时，需要对用户输入内容分词，但<strong>默认的分词规则对中文处理并不友好</strong>，我们在kibana的DevTools中测试</p>
<pre><code class="json">POST /_analyze
&#123;
    &quot;analyzer&quot;:&quot;standard&quot;,
    &quot;text&quot;:&quot;学习分布式搜索引擎ElasticSearch&quot;
&#125;
</code></pre>
<p><strong>语法说明：</strong></p>
<p>POST：请求方式</p>
<p>&#x2F;_analyze：请求路径，这里省略了<code>http://192.168.119.88:9200</code>，由kibana帮我们补充</p>
<p>请求参数，json风格：</p>
<ul>
<li>analyzer：分词器类型，这里使用的是默认的standard分词器</li>
<li>text：要分词的内容</li>
</ul>
<h3 id="IK分词器"><a href="#IK分词器" class="headerlink" title="IK分词器"></a>IK分词器</h3><h4 id="安装分词器"><a href="#安装分词器" class="headerlink" title="安装分词器"></a>安装分词器</h4><p>处理中文分词，一般会使用<strong>IK分词器</strong></p>
<p>网址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p>
<p><strong>安装IK分词器</strong></p>
<p><strong>在线拉取</strong></p>
<pre><code class="bash"># 进入容器内部
docker exec -it elasticsearch /bin/bash

# 在线下载并安装
./bin/elasticsearch-plugin  install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.12.1/elasticsearch-analysis-ik-7.12.1.zip

#退出
exit
#重启容器
docker restart elasticsearch
</code></pre>
<p><strong>离线安装</strong></p>
<p>安装插件需要知道elasticsearch的plugins目录位置，而我们用了数据卷挂载，因此需要查看elasticsearch的数据卷目录，通过下面命令查看</p>
<pre><code class="bash">docker volume inspect es-plugins
</code></pre>
<p>显示结果：</p>
<pre><code class="json">[
    &#123;
        &quot;CreatedAt&quot;: &quot;2022-05-06T10:06:34+08:00&quot;,
        &quot;Driver&quot;: &quot;local&quot;,
        &quot;Labels&quot;: null,
        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/es-plugins/_data&quot;,
        &quot;Name&quot;: &quot;es-plugins&quot;,
        &quot;Options&quot;: null,
        &quot;Scope&quot;: &quot;local&quot;
    &#125;
]
</code></pre>
<p>说明plugins目录被挂载到了：<code>/var/lib/docker/volumes/es-plugins/_data </code>这个目录中</p>
<p><strong>重启容器</strong></p>
<pre><code class="bash">#重启容器
docker restart es
#查看es日志
docker logs -f es
</code></pre>
<p><strong>测试IK分词器</strong></p>
<p>IK分词器包含两种模式：</p>
<ul>
<li><p><code>ik_smart</code>：最少切分（粗粒度切分，分词较少）</p>
</li>
<li><p><code>ik_max_word</code>：最细粒度切分（分词较多，带来的内存消耗大）</p>
</li>
</ul>
<h3 id="字典个性化设置"><a href="#字典个性化设置" class="headerlink" title="字典个性化设置"></a>字典个性化设置</h3><p>分词器都会依赖于一个<strong>字典</strong>来进行分词，我们可以为字典添加拓展词汇和停用词汇</p>
<p><strong>ik分词器-拓展词库</strong></p>
<p>要拓展ik分词器的词库，需要修改ik分词器目录下config目录中的<strong>IkAnalyzer.cfg.xml</strong>文件</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE properties SYSTEM &quot;http://java.sun.com/dtd/properties.dtd&quot;&gt;
&lt;properties&gt;
    &lt;comment&gt;IK Analyzer 扩展配置&lt;/comment&gt;
    
    &lt;!--用户可以在这里配置自己的扩展字典 --&gt;
    &lt;entry key=&quot;ext_dict&quot;&gt;&lt;/entry&gt;
    
    &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;
    &lt;entry key=&quot;ext_stopwords&quot;&gt;&lt;/entry&gt;
    
    &lt;!--用户可以在这里配置远程扩展字典 --&gt;
    &lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;
    
    &lt;!--用户可以在这里配置远程扩展停止词字典--&gt;
    &lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;

&lt;/properties&gt;
</code></pre>
<p>指定拓展词所在文件名（与当前目录同级）</p>
<pre><code class="xml">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;
&lt;entry key=&quot;ext_dict&quot;&gt;ext.dic&lt;/entry&gt;
 &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;
&lt;entry key=&quot;ext_stopwords&quot;&gt;stopword.dic&lt;/entry&gt;
</code></pre>
<p>创建ext.dic，添加扩展词即可，一行一个词语，注意必须都是<strong>UTF-8编码格式</strong></p>
<p><strong>分词器的作用</strong></p>
<ul>
<li>创建倒排索引时对文档分词</li>
<li>用户搜索时，对输入的内容分词</li>
</ul>
<h2 id="DSL-索引库操作"><a href="#DSL-索引库操作" class="headerlink" title="DSL-索引库操作"></a>DSL-索引库操作</h2><h3 id="mapping属性"><a href="#mapping属性" class="headerlink" title="mapping属性"></a>mapping属性</h3><p>mapping是对索引库中文档的约束，<strong>常见的mapping属性包括：</strong></p>
<ul>
<li><p><strong>type</strong> 	字段数据类型，常见类型有</p>
<ul>
<li><strong>字符串</strong>：<strong>text</strong>（可分词的文本），<strong>keyword</strong>（精确值，例如：品牌，国家，ip地址）是否可以拆分</li>
<li><strong>数值</strong>：long，integer，short，byte，double，float</li>
<li><strong>布尔</strong>：boolean</li>
<li><strong>日期</strong>：date</li>
<li><strong>对象</strong>：object（内部有子字段）</li>
</ul>
<p>在es中没有数组，但是允许某个字段有多个值</p>
</li>
<li><p><strong>index</strong>：是否创建倒排索引，默认为true（是否参与倒排索引）</p>
</li>
<li><p><strong>analyzer</strong>：使用哪种分词器（结合text类型使用）</p>
</li>
<li><p><strong>properties</strong>：该字段的子字段</p>
</li>
</ul>
<pre><code class="json">&#123;
    &quot;age&quot;:21,
    &quot;weight&quot;:53.2,
    &quot;isMarried&quot;:false,
    &quot;info&quot;:&quot;简介内容&quot;,
    &quot;email&quot;:&quot;os467@qq.com&quot;,
    &quot;score&quot;:[99.1,99.5,98.9],
    &quot;name&quot;:&#123;
        &quot;firstName&quot;:&quot;三&quot;,
        &quot;lastName&quot;:&quot;张&quot;
    &#125;
&#125;
</code></pre>
<h3 id="创建索引库"><a href="#创建索引库" class="headerlink" title="创建索引库"></a>创建索引库</h3><p>ES中通过Restful请求操作索引库、文档，请求内容用DSL语句来表示</p>
<p>创建索引库和mapping的DSL语法如下：</p>
<pre><code class="json">PUT /索引库名称
&#123;
    &quot;mappings&quot;:&#123;
        &quot;properties&quot;:&#123;
            &quot;字段名1&quot;:&#123;
                &quot;type&quot;:&quot;text&quot;,
                &quot;analyzer&quot;:&quot;ik_smart&quot;
            &#125;,
            &quot;字段名2&quot;:&#123;
                &quot;type&quot;:&quot;keyword&quot;,
                &quot;index&quot;:&quot;false&quot;
            &#125;,
            &quot;字段名3&quot;:&#123;
                &quot;properties&quot;:&#123;
                    &quot;子字段&quot;:&#123;
                        &quot;type&quot;:&quot;keyword&quot;
                    &#125;
                &#125;
            &#125;,
            //...略
        &#125;
    &#125;
&#125;
</code></pre>
<p><strong>创建索引库</strong></p>
<pre><code class="json">#创建索引库
PUT /os467
&#123;
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;info&quot;:&#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;ik_smart&quot;
      &#125;,
      &quot;email&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;index&quot;: false
      &#125;,
      &quot;name&quot;:&#123;
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: &#123;
          &quot;firstName&quot;:&#123;
            &quot;type&quot;: &quot;keyword&quot;
          &#125;,
          &quot;lastName&quot;:&#123;
            &quot;type&quot;: &quot;keyword&quot;
          &#125;
        &#125;
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<h3 id="查询、删除索引库"><a href="#查询、删除索引库" class="headerlink" title="查询、删除索引库"></a>查询、删除索引库</h3><pre><code class="json">#查询索引库
GET /索引库名称
#删除索引库
DELETE /索引库名称
</code></pre>
<h3 id="修改索引库"><a href="#修改索引库" class="headerlink" title="修改索引库"></a>修改索引库</h3><p><strong>禁止修改原有字段</strong></p>
<p>禁止修改索引库原有字段，因为mapping约束定义好后，es就会创建倒排索引库，如果修改原字段会对倒排索引库产生影响</p>
<p><strong>添加新字段</strong></p>
<p>索引库和mapping一旦创建无法修改，但可以添加新字段（<strong>新字段名不能和旧字段名重复</strong>）</p>
<pre><code class="json">PUT /索引库名称/_mapping
&#123;
    &quot;properties&quot;:&#123;
        &quot;新字段名&quot;:&#123;
            &quot;type&quot;:&quot;integer&quot;
        &#125;
    &#125;
&#125;
</code></pre>
<p><strong>测试</strong></p>
<pre><code class="json">#修改索引库，添加新字段
PUT /os467/_mapping
&#123;
  &quot;properties&quot;:&#123;
    &quot;age&quot;:&#123;
      &quot;type&quot;:&quot;integer&quot;
    &#125;
  &#125;
&#125;
</code></pre>
<h2 id="DSL-文档操作"><a href="#DSL-文档操作" class="headerlink" title="DSL-文档操作"></a>DSL-文档操作</h2><h3 id="新增文档"><a href="#新增文档" class="headerlink" title="新增文档"></a>新增文档</h3><p>每次写操作都会导致文档版本增加</p>
<p><strong>DSL语法：</strong></p>
<p>如果不加id，会由ES随机生成id</p>
<pre><code class="json">POST /索引库名称/_doc/文档id
&#123;
    &quot;字段1&quot;:&quot;值1&quot;,
    &quot;字段2&quot;:&quot;值2&quot;,
    &quot;字段3&quot;:&#123;
        &quot;子字段1&quot;:&quot;值3&quot;,
        &quot;子字段2&quot;:&quot;值4&quot;
    &#125;,
    //...略
&#125;
</code></pre>
<p><strong>测试</strong></p>
<pre><code class="json">#插入文档
POST /os467/_doc/1
&#123;
  &quot;info&quot;:&quot;os467的个人简介内容&quot;,
  &quot;email&quot;:&quot;os467@qq.com&quot;,
  &quot;name&quot;:&#123;
    &quot;firstName&quot;:&quot;三&quot;,
    &quot;lastName&quot;:&quot;张&quot;
  &#125;
&#125;
</code></pre>
<h3 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h3><pre><code class="json">GET /索引库名称/_doc/文档id
</code></pre>
<p><strong>测试</strong></p>
<pre><code class="json">#查询文档
GET /os467/_doc/1
</code></pre>
<h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h3><pre><code class="json">DELETE /索引库名称/_doc/文档id
</code></pre>
<p><strong>测试</strong></p>
<pre><code class="json">#删除文档
DELETE /os467/_doc/1
</code></pre>
<h3 id="修改文档"><a href="#修改文档" class="headerlink" title="修改文档"></a>修改文档</h3><p>方式一：全量修改，<strong>会删除旧文档</strong>，<strong>添加新文档</strong>（如果id不存在则新增）</p>
<pre><code class="json">PUT /索引库名称/_doc/文档id
&#123;
    &quot;字段1&quot;:&quot;值1&quot;,
    &quot;字段2&quot;:&quot;值2&quot;
    //...略
&#125;
</code></pre>
<p><strong>测试</strong></p>
<pre><code class="json">#全量修改文档
PUT /os467/_doc/1
&#123;
  &quot;info&quot;:&quot;os467的个人简介内容&quot;,
  &quot;email&quot;:&quot;zhangsan@qq.com&quot;,
  &quot;name&quot;:&#123;
    &quot;firstName&quot;:&quot;三&quot;,
    &quot;lastName&quot;:&quot;张&quot;
  &#125;
&#125;
</code></pre>
<p>方式二：增量修改（局部修改），<strong>修改指定字段</strong></p>
<pre><code class="json">POST /索引库名/_update/文档id
&#123;
    &quot;doc&quot;:&#123;
        &quot;字段名&quot;:&quot;新的值&quot;
    &#125;
&#125;
</code></pre>
<p><strong>测试</strong></p>
<pre><code class="json">#局部修改文档字段
POST /os467/_update/1
&#123;
    &quot;doc&quot;:&#123;
        &quot;email&quot;:&quot;os467@qq.com&quot;
    &#125;
&#125;
</code></pre>
<h2 id="RestClient操作索引库"><a href="#RestClient操作索引库" class="headerlink" title="RestClient操作索引库"></a>RestClient操作索引库</h2><p>以后在java开发中，我们会使用java代码来实现操作es引擎，因此我们使用es官方提供的RestClient</p>
<p><strong>什么是RestClient？</strong></p>
<p>ES官方提供了各种不同语言的客户端，用来操作ES，这些客户端的<strong>本质</strong>就是组装DSL语句，通过http请求发送给ES</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/index.html">https://www.elastic.co/guide/en/elasticsearch/client/index.html</a></p>
<p>利用JavaRestClient实现创建、删除索引库，判断索引库是否存在</p>
<p>mapping要考虑的问题：</p>
<p>字段名、数据类型、是否参与搜索、是否分词、如果分词，分词器是什么</p>
<p><strong>ES中支持两种地理坐标数据类型：</strong></p>
<ul>
<li><p>geo_point：由维度（latitude）和经度（longitude）确定的一个点，例如</p>
<p>“116.397128, 39.916527”</p>
</li>
<li><p>geo_shape：有多个geo_point组成的复杂几何图形，例如一条直线</p>
<p>“LINESTRING(-74.19231902148438, -56.6090593036236)”</p>
</li>
</ul>
<p><strong>字段拷贝</strong></p>
<p>当我们需要对几个<strong>相关字段</strong>进行查询的时候，我们可以使用copy_to工具来高效的创建一个新的字段来存储我们需要查询的词</p>
<p>字段拷贝可以使用copy_to属性将当前字段拷贝到指定字段，实例：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_21383435/article/details/118884992?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~PayColumn-1-118884992-blog-106975556.pc_relevant_multi_platform_whitelistv6&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~PayColumn-1-118884992-blog-106975556.pc_relevant_multi_platform_whitelistv6&utm_relevant_index=1">参考博客</a></p>
<pre><code class="json">&quot;all&quot;:&#123;
    &quot;type&quot;: &quot;text&quot;,
    &quot;analyzer&quot;: &quot;ik_max_word&quot;
&#125;,
&quot;brand&quot;:&#123;
    &quot;type&quot;: &quot;keyword&quot;,
    &quot;copy_to&quot;: &quot;all&quot;
&#125;
</code></pre>
<p><strong>示例</strong></p>
<pre><code class="json"># 酒店的mapping
PUT /hotel
&#123;
  &quot;mappings&quot;: &#123;
    &quot;properties&quot;: &#123;
      &quot;id&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;name&quot;:&#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;ik_max_word&quot;,
        &quot;copy_to&quot;: &quot;all&quot;
      &#125;,
      &quot;address&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;index&quot;: false
      &#125;,
      &quot;price&quot;:&#123;
        &quot;type&quot;: &quot;integer&quot;
      &#125;,
      &quot;score&quot;:&#123;
        &quot;type&quot;: &quot;integer&quot;
      &#125;,
      &quot;brand&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;copy_to&quot;: &quot;all&quot;
      &#125;,
      &quot;city&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;starName&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;
      &#125;,
      &quot;business&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;copy_to&quot;: &quot;all&quot;
      &#125;,
      &quot;location&quot;:&#123;
        &quot;type&quot;: &quot;geo_point&quot;
      &#125;,
      &quot;pic&quot;:&#123;
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;index&quot;: false
      &#125;,
      &quot;all&quot;:&#123;
        &quot;type&quot;: &quot;text&quot;,
        &quot;analyzer&quot;: &quot;ik_max_word&quot;
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<h3 id="初始化JavaRestClient"><a href="#初始化JavaRestClient" class="headerlink" title="初始化JavaRestClient"></a>初始化JavaRestClient</h3><p><strong>引入es的RestHighLevelClient依赖坐标</strong></p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;
    &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>因为SpringBoot默认的ES版本是7.6.2，所以我们需要<strong>覆盖默认的ES版本</strong></p>
<pre><code class="xml">&lt;properties&gt;
    &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;elasticsearch.version&gt;7.12.1&lt;/elasticsearch.version&gt;
&lt;/properties&gt;
</code></pre>
<p>初始化<strong>RestHighLevelClient</strong></p>
<pre><code class="java">RestHighLevelClient client = new RestHighLevelClient(RestClient.builder(
                HttpHost.create(&quot;http://192.168.119.88:9200&quot;)
        ));
</code></pre>
<p><strong>测试</strong></p>
<pre><code class="java">package cn.itcast.hotel;


import org.apache.http.HttpHost;
import org.elasticsearch.client.RestClient;
import org.elasticsearch.client.RestHighLevelClient;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;

import java.io.IOException;


public class HotelIndexTest &#123;

    private RestHighLevelClient client;

    @BeforeEach
    void setUp()&#123;
        this.client = new RestHighLevelClient(RestClient.builder(
                HttpHost.create(&quot;http://192.168.119.88:9200&quot;)
        ));
    &#125;


    @AfterEach
    void tearDown() throws IOException &#123;
        this.client.close();
    &#125;

&#125;
</code></pre>
<h4 id="Java索引库操作"><a href="#Java索引库操作" class="headerlink" title="Java索引库操作"></a>Java索引库操作</h4><h5 id="创建索引库-1"><a href="#创建索引库-1" class="headerlink" title="创建索引库"></a>创建索引库</h5><p><strong>步骤：</strong></p>
<p>1、准备request对象，指定<strong>索引库名称</strong></p>
<p>2、指定DSL，以及格式为JSON</p>
<p>3、获取到索引库操作对象，调用创建索引库的方法</p>
<p><strong>测试</strong></p>
<pre><code class="java">@Test
void testCreateHotelIndex()&#123;

    //1、创建Request对象，需要传入索引库名称
    CreateIndexRequest request = new CreateIndexRequest(&quot;hotel&quot;);

    //2、请求参数：DSL语句，MAPPING_TEMPLATE是静态常量字符串，内容是创建索引库的DSL语句
    request.source(MAPPING_TEMPLATE, XContentType.JSON);

    try &#123;
        //发起请求
        //indices返回的对象中包含索引库操作的所有方法，索引库操作对象
        client.indices().create(request, RequestOptions.DEFAULT);
    &#125; catch (IOException e) &#123;
        e.printStackTrace();
    &#125;

&#125;
</code></pre>
<h5 id="删除索引库"><a href="#删除索引库" class="headerlink" title="删除索引库"></a>删除索引库</h5><pre><code class="java">   @Test
    void testDeleteHotelIndex()&#123;

        //1、创建Request对象
        DeleteIndexRequest request = new DeleteIndexRequest(&quot;hotel&quot;);

        try &#123;
            //2、发送请求
            client.indices().delete(request,RequestOptions.DEFAULT);
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125;

    &#125;
</code></pre>
<h5 id="判断索引库是否存在"><a href="#判断索引库是否存在" class="headerlink" title="判断索引库是否存在"></a>判断索引库是否存在</h5><pre><code class="java">@Test
    void testExistsHotelIndex()&#123;

        //1、创建Request对象
        GetIndexRequest request = new GetIndexRequest(&quot;hotel&quot;);

        try &#123;
            //2、发送请求
            boolean exists = client.indices().exists(request, RequestOptions.DEFAULT);
            //3、输出
            System.out.println(exists ? &quot;索引库存在&quot;:&quot;索引库不存在&quot;);
            
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125;

    &#125;
</code></pre>
<h4 id="Java文档操作"><a href="#Java文档操作" class="headerlink" title="Java文档操作"></a>Java文档操作</h4><h5 id="添加新的文档"><a href="#添加新的文档" class="headerlink" title="添加新的文档"></a>添加新的文档</h5><p><strong>IndexRequest</strong></p>
<ul>
<li><code>IndexRequest(&quot;hotel&quot;)</code> ：指定索引库的名称</li>
<li><code>id()</code>：需要接收字符串类型的参数，一般使用<code>toString()</code>转换</li>
<li><code>index()</code>：用于操作索引库文档的方法，这里用于添加文档信息</li>
</ul>
<pre><code class="java">@Test
void testAddDocument()&#123;

    //根据id查询酒店数据，使用mybatisPlus查询到结果
    Hotel hotel = hotelService.getById(61083L);

    //转换为索引库需要的文档类型，主要是location字段的差异
    HotelDoc hotelDoc = new HotelDoc(hotel);

    //1、创建request对象
    IndexRequest request = new IndexRequest(&quot;hotel&quot;).id(hotel.getId().toString());

    //2、准备JSON文件，调用fastjson的api将hotelDoc数据转换为json串
    request.source(JSON.toJSONString(hotelDoc),XContentType.JSON);

    //3、发送请求
    try &#123;

        //文档新增
        client.index(request,RequestOptions.DEFAULT);

    &#125; catch (IOException e) &#123;
        e.printStackTrace();
    &#125;

&#125;
</code></pre>
<h5 id="查询文档数据"><a href="#查询文档数据" class="headerlink" title="查询文档数据"></a>查询文档数据</h5><p><strong>GetRequest</strong></p>
<ul>
<li><code>getSourceAsString()</code>：得到响应对象资源</li>
</ul>
<pre><code class="java">@Test
void testGetDocumentById()&#123;
    //1、准备request
    GetRequest request = new GetRequest(&quot;hotel&quot;, &quot;61083&quot;);

    //2、发送请求，得到响应
    GetResponse response = null;
    try &#123;
        response = client.get(request, RequestOptions.DEFAULT);
    &#125; catch (IOException e) &#123;
        e.printStackTrace();
    &#125;

    //3、解析响应结果
    String json = response.getSourceAsString();

    //4、反序列化JSON串
    HotelDoc hotelDoc = JSON.parseObject(json, HotelDoc.class);

    System.out.println(hotelDoc);
&#125;
</code></pre>
<h5 id="更新文档数据"><a href="#更新文档数据" class="headerlink" title="更新文档数据"></a>更新文档数据</h5><p>修改文档数据有两种方式：</p>
<ul>
<li><p>方式一：全局更新，再次写入id一样的文档，就会删除旧文档，添加新文档</p>
</li>
<li><p>方式二：局部更新，只更新部分字段</p>
</li>
</ul>
<p><strong>测试局部更新</strong></p>
<p><strong>UpdateRequest</strong></p>
<pre><code class="java">@Test
void testUpdateDocumentById() throws IOException&#123;
    //1、创建request对象
    UpdateRequest request = new UpdateRequest(&quot;hotel&quot;,&quot;61083&quot;);

    //2、准备参数，每两个参数为一对key，value
    request.doc(
            &quot;price&quot;,952,
            &quot;starName&quot;,&quot;四钻&quot;
    );

    //3、更新文档
    client.update(request,RequestOptions.DEFAULT);
    
&#125;
</code></pre>
<h5 id="删除文档数据"><a href="#删除文档数据" class="headerlink" title="删除文档数据"></a>删除文档数据</h5><p><strong>DeleteRequest</strong></p>
<pre><code class="java">@Test
void testDeleteDocumentById()&#123;

    //1、创建request对象
    DeleteRequest request = new DeleteRequest(&quot;hotel&quot;,&quot;61083&quot;);

    //2、发送请求
    try &#123;
        client.delete(request,RequestOptions.DEFAULT);
    &#125; catch (IOException e) &#123;
        e.printStackTrace();
    &#125;

&#125;
</code></pre>
<h5 id="Bulk批量处理"><a href="#Bulk批量处理" class="headerlink" title="Bulk批量处理"></a>Bulk批量处理</h5><p>批量添加可以将多个请求放入一个bulk请求中做批量添加的处理</p>
<pre><code class="java">@Test
void testBulkRequest()&#123;

    //批量获取到酒店数据
    List&lt;Hotel&gt; hotels = hotelService.list();

    //1、创建Bulk请求
    BulkRequest request = new BulkRequest();

    //2、准备参数，添加多个新增Request
    for (Hotel hotel : hotels) &#123;
        //转换为文档类型HotelDoc
        HotelDoc hotelDoc = new HotelDoc(hotel);

        //创建新增文档的Request对象
        request.add(new IndexRequest(&quot;hotel&quot;)
                .id(hotelDoc.getId().toString())
                .source(JSON.toJSONString(hotelDoc),XContentType.JSON));

    &#125;

    //3、发送请求
    try &#123;
        client.bulk(request,RequestOptions.DEFAULT);
    &#125; catch (IOException e) &#123;
        e.printStackTrace();
    &#125;
&#125;
</code></pre>
<h2 id="ES搜索功能"><a href="#ES搜索功能" class="headerlink" title="ES搜索功能"></a>ES搜索功能</h2><h3 id="DSL-查询文档"><a href="#DSL-查询文档" class="headerlink" title="DSL-查询文档"></a>DSL-查询文档</h3><p><strong>DSL Query的分类</strong></p>
<p>Elasticsearch提供了基于JSON的DSL（Domain Specific Language）来定义查询</p>
<ul>
<li><strong>查询所有：</strong>查询所有数据（有分页限制），一般测试用：match_all</li>
<li><strong>全文检索（full text）查询：</strong>利用分词器对用户输入的内容分词，然后去倒排索引库中匹配<ul>
<li>match_query</li>
<li>multi_match_query</li>
</ul>
</li>
<li><strong>精确查询：</strong>根据精确词条值查找数据，一般是查找keyword，数值，日期，boolean等类型字段<ul>
<li>ids</li>
<li>range</li>
<li>term</li>
</ul>
</li>
<li><strong>地理（geo）查询：</strong>根据经纬度查询<ul>
<li>geo_distance</li>
<li>geo_bounding_box</li>
</ul>
</li>
<li><strong>复合（compound）查询：</strong>复合查询可以将上述各种查询条件组合起来，合并查询条件<ul>
<li>bool</li>
<li>function_score</li>
</ul>
</li>
</ul>
<p><strong>DSL Query基本语法</strong></p>
<p>查询的基本语法如下：</p>
<pre><code class="json">GET /indexName/_search
&#123;
    &quot;query&quot;:&#123;
        &quot;查询类型&quot;:&#123;
            &quot;查询条件&quot;:&quot;条件值&quot;
        &#125;
    &#125;
&#125;
</code></pre>
<p><strong>查询所有</strong></p>
<pre><code class="json">#查询所有
GET /hotel/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;
&#125;
</code></pre>
<h4 id="全文检索查询"><a href="#全文检索查询" class="headerlink" title="全文检索查询"></a>全文检索查询</h4><p>全文检索查询，会对用户输入内容分词，<strong>常用于搜索框搜索：</strong></p>
<ul>
<li><p><strong>match查询：</strong>全文检索查询的一种，会对用户输入内容分词，然后去倒排索引库检索</p>
</li>
<li><p><strong>语法：</strong></p>
<ul>
<li><strong>FIELD：</strong>指定查询的字段名称</li>
<li><strong>TEXT：</strong>用户查询的内容</li>
</ul>
<pre><code class="json">GET /indexName/_search
&#123;
    &quot;query&quot;:&#123;
        &quot;match&quot;:&#123;
            &quot;FIELD&quot;:&quot;TEXT&quot;
        &#125;
    &#125;
&#125;
</code></pre>
<p><strong>测试：</strong></p>
<pre><code class="json">GET /hotel/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match&quot;: &#123;
      &quot;all&quot;: &quot;如家外滩&quot;
    &#125;
  &#125;
&#125;
</code></pre>
</li>
<li><p><strong>multi_match查询：</strong>与match查询类似，只不过允许同时查询<strong>多个字段</strong></p>
</li>
<li><p><strong>语法：</strong></p>
<ul>
<li><strong>query：</strong>用户输入的内容</li>
<li><strong>fields：</strong>指定参与查询的多个字段</li>
</ul>
<pre><code class="json">GET /indexName/_search
&#123;
    &quot;query&quot;:&#123;
        &quot;multi_match&quot;:&#123;
            &quot;query&quot;:&quot;TEXT&quot;,
            &quot;fields&quot;:[&quot;FIELD1&quot;,&quot;FIELD2&quot;]
        &#125;
    &#125;
&#125;
</code></pre>
<p><strong>测试：</strong></p>
<pre><code class="json">GET hotel/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;multi_match&quot;: &#123;
      &quot;query&quot;: &quot;外滩如家&quot;,
      &quot;fields&quot;: [&quot;brand&quot;,&quot;name&quot;,&quot;business&quot;]
    &#125;
  &#125;
&#125;
</code></pre>
<blockquote>
<p>和match查询all字段内容效果差不多，但是<strong>查询字段越多性能越差</strong>，因此推荐使用all字段结合copy_to的方法</p>
</blockquote>
</li>
</ul>
<h4 id="精确查询"><a href="#精确查询" class="headerlink" title="精确查询"></a>精确查询</h4><p>精确查询一般是查找keyword、数值、日期、boolean等类型字段，所以<strong>不会</strong>对搜索条件分词，<strong>常见的有：</strong></p>
<ul>
<li><p><strong>term查询：</strong>根据词条精确值查询</p>
</li>
<li><p><strong>语法：</strong></p>
<ul>
<li><strong>FIELD：</strong>指定查询的字段名称</li>
<li><strong>value：</strong>精确查询的内容</li>
</ul>
<pre><code class="json">GET /indexName/_search
&#123;
    &quot;query&quot;:&#123;
        &quot;term&quot;:&#123;
            &quot;FIELD&quot;:&#123;
                &quot;value&quot;:&quot;VALUE&quot;
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>
<p><strong>测试：</strong></p>
<pre><code class="json">#term查询
GET hotel/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;term&quot;: &#123;
      &quot;city&quot;: &#123;
        &quot;value&quot;: &quot;上海&quot;
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
</li>
<li><p><strong>range查询：</strong>根据值的范围查询，可以是数值，日期的范围</p>
</li>
<li><p><strong>语法：</strong></p>
<ul>
<li><strong>FIELD：</strong>指定查询的字段名称</li>
<li><strong>gte：</strong>指定大于等于某个值 （gt：大于）</li>
<li><strong>lte：</strong>指定小于等于某个值  (lt：小于)</li>
</ul>
<pre><code class="json">GET /indexName/_search
&#123;
    &quot;query&quot;:&#123;
        &quot;range&quot;:&#123;
            &quot;FIELD&quot;:&#123;
                &quot;gte&quot;:10,
                &quot;lte&quot;:20
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>
<p><strong>测试：</strong></p>
<pre><code class="json">#range查询
GET hotel/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;range&quot;: &#123;
      &quot;price&quot;: &#123;
        &quot;gte&quot;: 100,
        &quot;lte&quot;: 300
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
</li>
</ul>
<h4 id="地理查询"><a href="#地理查询" class="headerlink" title="地理查询"></a>地理查询</h4><p>根据经纬度查询，常见的使用场景包括</p>
<p>携程：搜索我附近的酒店</p>
<p>滴滴：搜索我附近的出租车</p>
<ul>
<li><p><strong>geo_bounding_box查询：</strong>查询geo_point值落在某个矩形范围的所有文档</p>
</li>
<li><p><strong>语法：</strong></p>
<ul>
<li><strong>FIELD：</strong>文档中指定为geo_point的字段</li>
</ul>
<pre><code class="json">GET /indexName/_search
&#123;
    &quot;query&quot;:&#123;
        &quot;geo_bounding_box&quot;:&#123;
            &quot;FIELD&quot;:&#123;
                &quot;top_left&quot;:&#123;
                    &quot;lat&quot;:31.1,
                    &quot;lon&quot;:121.5
                &#125;,
                &quot;bottom_right&quot;:&#123;
                    &quot;lat&quot;:30.9,
                    &quot;lon&quot;:121.7
                &#125;
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>
</li>
<li><p><strong>geo_distance查询：</strong>查询到指定中心点小于某个距离值的所有文档</p>
</li>
<li><p><strong>语法：</strong></p>
<ul>
<li><strong>distance：</strong>到中心点的距离范围</li>
<li><strong>FIELD：</strong>指定的中心点</li>
</ul>
<pre><code class="json">GET /indexName/_search
&#123;
    &quot;query&quot;:&#123;
        &quot;geo_distance&quot;:&#123;
            &quot;distance&quot;:&quot;15km&quot;,
            &quot;FIELD&quot;:&quot;31.21,121.5&quot;
        &#125;
    &#125;
&#125;
</code></pre>
<p><strong>测试：</strong></p>
<pre><code class="json">GET /hotel/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;geo_distance&quot;:&#123;
      &quot;distance&quot;:&quot;15km&quot;,
      &quot;location&quot;:&quot;31.21,121.5&quot;
    &#125;
  &#125;
&#125;
</code></pre>
</li>
</ul>
<h4 id="复合查询"><a href="#复合查询" class="headerlink" title="复合查询"></a>复合查询</h4><p><strong>复合（compound）查询：</strong>复合查询可以将其它简单查询组合起来，实现更复杂的搜索逻辑，<strong>例如：</strong></p>
<ul>
<li><p><strong>function_score查询：</strong>算分函数查询，可以<strong>控制文档相关性算分</strong>，控制文档排名，例如百度竞价</p>
<p>当我们利用match查询时，文档结果会根据与搜索词条的关联度打分（_score），返回结果时按照分值降序排列</p>
<p><strong>ES中的相关性打分算法：</strong><br>$$<br>TF(词条频率) &#x3D; \frac {词条出现次数}{文档中词条总数}<br>$$</p>
</li>
</ul>
<p>$$<br>TF-IDF算法<br>\<br>\<br>IDF(逆文档频率) &#x3D; log(\frac {文档总数}{包含词条的文档总数}) \<br>score &#x3D; \sum_i^n TF(词条频率) * IDF(逆文档频率)<br>$$</p>
<blockquote>
<p> TF-IDF是一种统计方法，用以评估一字词对于一个文件集或一个语料库中的其中一份文件的重要程度，<strong>字词的重要性随着它在文件中出现的次数成正比增加，但同时会随着它在语料库中出现的频率成反比下降</strong></p>
</blockquote>
<p>$$<br>BM25算法<br>\<br>Score(Q,d) &#x3D; \sum_i^nlog(1 + \frac {N-n+0.5}{n+0.5})· (\frac {f_i}{fi+k_1·(1-b+b·\frac{dl}{avgdl})})<br>$$</p>
<blockquote>
<p>在es5.0后使用此算法，BM25算法不会受词频影响较大，在传统TF算法中，词频越高，得分会无限增加，但BM25会趋近于水平，曲线更加平滑</p>
</blockquote>
<ul>
<li><p><strong>语法：</strong></p>
<ul>
<li><p><strong>query：</strong>原始查询条件，搜索文档并根据相关性打分（<code>query score</code>）</p>
</li>
<li><p><strong>filter：</strong>过滤条件，符合条件的文档才会被重新算分 </p>
</li>
<li><p><strong>weight：</strong>算分函数，算分函数的结果称为<code>function score</code>，将来会与<code>query score</code>运算，得到新算分，常见的算分函数有：</p>
<ul>
<li>weight：给一个<strong>常量值</strong>，作为函数结果（<code>function score</code>）</li>
<li>field_value_factor：用文档中的某个字段值作为函数结果</li>
<li>random_score：随机生成一个值，作为函数结果</li>
<li>script_score：自定义计算公式，公式结果作为函数结果</li>
</ul>
</li>
<li><p><strong>boost_mode：</strong>加权模式，定义<code>function score</code>与<code>query score</code>的运算方式，包括：</p>
<ul>
<li>multiply：两者相乘（默认）</li>
<li>replace：用<code>function score</code> 替换<code>query score</code></li>
<li>其它：<code>sum</code>，<code>avg</code>，<code>max</code>，<code>min</code></li>
</ul>
</li>
</ul>
<p>&#96;&#96;&#96;json</p>
</li>
</ul>
<p>GET &#x2F;hotel&#x2F;_search<br>{<br>    “query”:{<br>        “function_score”:{<br>            “query”:{“match”:{“all”:”外滩”}},<br>            “functions”:[<br>                {<br>                    “filter”:{“term”:{“id”:”1”}},<br>                    “weight”:10<br>                }<br>            ],<br>            “boost_mode”:”multiply”<br>        }<br>    }<br>}</p>
<pre><code>
**测试：**

```json
GET /hotel/_search
&#123;
  &quot;query&quot;:&#123;
      &quot;function_score&quot;:&#123;
          &quot;query&quot;:&#123;&quot;match&quot;:&#123;
              &quot;all&quot;:&quot;外滩&quot;
          &#125;&#125;,
          &quot;functions&quot;:[
              &#123;
                  &quot;filter&quot;:&#123;
                      &quot;term&quot;:&#123;
                          &quot;brand&quot;:&quot;如家&quot;
                      &#125;
                  &#125;,
                  &quot;weight&quot;:10
              &#125;
          ],
          &quot;boost_mode&quot;:&quot;sum&quot;
      &#125;
  &#125;
&#125;
</code></pre>
<ul>
<li><p><strong>Boolean Query查询：</strong>布尔查询是一个或多个查询子句的组合，子查询的组合方式有：</p>
<ul>
<li>must：必须匹配每个子查询，类似<strong>与</strong>（一般指定的是关键字）</li>
<li>should：选择性匹配子查询，类似<strong>或</strong></li>
<li>must_not：必须不匹配，<strong>不参与算分</strong>，类似<strong>非</strong></li>
<li>filter：必须匹配，<strong>不参与算分</strong>（可以减少使用BM25算法带来的性能消耗）</li>
</ul>
<p><strong>语法：</strong></p>
<p>&#96;&#96;&#96;json</p>
</li>
</ul>
<p>GET &#x2F;hotel&#x2F;_search<br>{<br>    “query”:{<br>        “bool”:{<br>            “must”:[<br>                {“term”:{“FIELD”:”TEXT”}}<br>            ],<br>            “should”:[<br>                {“term”:{“FIELD”:”TEXT”}},<br>                {“term”:{“FIELD”:”TEXT”}}<br>            ],<br>            “must_not”:[<br>              {“range”:{“price”:{“lte”:500}}}<br>            ],<br>            “filter”:[<br>                {“range”:{“score”:{“gte”:45}}}<br>            ]<br>        }<br>    }<br>}</p>
<pre><code>
**测试：**

​	需求：搜索名字包含“如家“，价格不高于400，在坐标31.21，121.5周围10km范围内的酒店

```json
GET /hotel/_search
&#123;
  &quot;query&quot;:&#123;
      &quot;bool&quot;:&#123;
          &quot;must&quot;:[
              &#123;
                  &quot;match&quot;:&#123;&quot;name&quot;:&quot;如家酒店&quot;&#125;
              &#125;
          ],
          &quot;must_not&quot;: [
              &#123;
                  &quot;range&quot;: &#123;&quot;price&quot;: &#123;&quot;gte&quot;: 500&#125;&#125;
              &#125;
          ],
          &quot;filter&quot;:[
              &#123;
                  &quot;geo_distance&quot;:&#123;&quot;distance&quot;:&quot;10km&quot;,&quot;location&quot;:&quot;31.21,121.5&quot;&#125;
              &#125;  
          ]
      &#125;
  &#125;
&#125;
</code></pre>
<h3 id="搜索结果处理"><a href="#搜索结果处理" class="headerlink" title="搜索结果处理"></a>搜索结果处理</h3><h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><p>elasticsearch支持对搜索<strong>结果排序</strong>，默认是根据相关度算分（_score）来排序，可以排序字段类型有：keyword类型、数值类型、地理坐标类型，日期类型等</p>
<p><strong>sort参数：</strong> 指定字段和排序的方法</p>
<pre><code class="json">GET /indexName/_search
&#123;
    &quot;query&quot;:&#123;
        &quot;match_all&quot;:&#123;&#125;
    &#125;,
    &quot;sort&quot;:[
        &#123;
            &quot;FIELD&quot;:&quot;desc&quot; //排序字段和排序方式ASC、DESC
        &#125;
    ]
&#125;
</code></pre>
<p>需求：查询酒店信息，先按评分降序，再按价格升序</p>
<pre><code class="json">GET /hotel/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;,
  &quot;sort&quot;: [
    &#123;
      &quot;score&quot;:&quot;desc&quot;
    &#125;,
    &#123;
      &quot;price&quot;: &quot;asc&quot;
    &#125;
  ]
&#125;
</code></pre>
<p>需求：对酒店数据按照到指定位置坐标的距离升序排序</p>
<pre><code class="json">GET /hotel/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match_all&quot;: &#123;&#125;
  &#125;,
  &quot;sort&quot;: [
    &#123;
      &quot;_geo_distance&quot;: &#123;
        &quot;location&quot;: &#123;
          &quot;lat&quot;: 31.034661,
          &quot;lon&quot;: 121.612282
        &#125;,
        &quot;order&quot;: &quot;asc&quot;,
        &quot;unit&quot;: &quot;km&quot;
      &#125;
    &#125;
  ]
&#125;
</code></pre>
<h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><p>elasticsearch 默认情况下只返回前十条数据，而如果要查询更多数据就需要修改分页参数了</p>
<p>elasticsearch中通过修改from，size参数来控制要返回的分页结果：</p>
<p><strong>from参数：</strong>分页起始位置</p>
<p><strong>size参数：</strong>分页单位</p>
<pre><code class="json">GET /hotel/_search
&#123;
    &quot;query&quot;:&#123;
        &quot;match_all&quot;:&#123;&#125;
    &#125;,
    &quot;from&quot;:0, //分页开始的位置，默认为0
    &quot;size&quot;:10, //分页单位
    &quot;sort&quot;:[
        &#123;&quot;price&quot;:&quot;asc&quot;&#125;
    ]
&#125;
</code></pre>
<blockquote>
<p>优点：支持随机翻页</p>
<p>缺点：深度分页问题，默认查询上限（from+size）是 10000</p>
<p>场景：百度、京东、谷歌、淘宝这样的随机翻页搜索</p>
</blockquote>
<p><strong>深度分页问题</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/w_t_y_y/article/details/109580356">ES集群相关博客</a></p>
<p>ES是分布式的，所以会面临深度分页问题</p>
<p>例如：按price排序后，获取from &#x3D; 990，size &#x3D; 10 的数据：</p>
<p>1、首先在每个数据分片上都排序并查询前1000条文档</p>
<p>2、然后将所有节点的结果聚合，在内存中重新排序选出1000条文档</p>
<p>3、最后从这1000条中，选取从990开始的10条文档</p>
<p>如果搜索的页数过深，或者结果集（from+size）越大，对内存和CPU的消耗也越高，因此ES设定结果集查询的上限是10000（一般从业务层面杜绝了深度分页，例如百度允许的查询页数上限是70页）</p>
<p><strong>深度分页解决方案</strong></p>
<p>针对深度分页，ES提供了两种解决方案<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html">官方文档</a>：</p>
<ul>
<li><p>search after：分页时<strong>需要排序</strong>，原理是从上一次的排序值开始，查询下一页数据（官方推荐）</p>
<ul>
<li><blockquote>
<p>优点：没有查询上限（单次查询的size不超过10000，多次可以）</p>
<p>缺点：只能向后逐页查询，不支持随机翻页</p>
<p>场景：没有随机翻页需求的搜索，例如手机向下滚动翻页</p>
</blockquote>
</li>
</ul>
</li>
<li><p>scroll：原理是将排序数据形成快照，保存在内存（官方已经不推荐使用）</p>
<ul>
<li><blockquote>
<p>优点：没有查询上限（单次查询的size不超过10000）</p>
<p>缺点：会有额外内存消耗，并且搜索结果是非实时的</p>
<p>场景：海量数据的获取和迁移，从ES7.1开始不推荐，建议用search_after方案</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h4 id="高亮"><a href="#高亮" class="headerlink" title="高亮"></a>高亮</h4><p>把搜索结果中的<strong>关键字突出显示</strong></p>
<p>服务端提前给关键字添加标签</p>
<ul>
<li><p>es在返回搜索结果的时候应该给这些关键字加上标签以便于后期前端添加样式</p>
</li>
<li><p>默认情况下，ES搜索字段必须与高亮字段一致</p>
</li>
<li><p><strong>语法：</strong></p>
<ul>
<li><strong>FIELD：</strong>指定要高亮的字段</li>
<li><strong>pre_tags、post_tags：</strong>前置标签和后置标签，默认为<code>em</code></li>
<li><strong>require_field_match：</strong>查询字段是否要和高亮字段匹配</li>
</ul>
<pre><code class="json">GET /hotel/_search
&#123;
    &quot;query&quot;:&#123;
        &quot;match&quot;:&#123;
            &quot;FIELD&quot;:&quot;TEXT&quot;
        &#125;
    &#125;,
    &quot;highlight&quot;:&#123;
        &quot;fields&quot;:&#123;
            &quot;FIELD&quot;:&#123; //指定要高亮的字段
                &quot;pre_tags&quot;:&quot;&lt;em&gt;&quot;, //用来标记高亮字段的前置标签
                &quot;post_tags&quot;:&quot;&lt;/em&gt;&quot; //用来标记高亮字段的后置标签
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>
</li>
<li><p><strong>测试：</strong></p>
<pre><code class="json">GET /hotel/_search
&#123;
  &quot;query&quot;: &#123;
    &quot;match&quot;: &#123;
      &quot;all&quot;:&quot;如家&quot;
    &#125;
  &#125;,
  &quot;highlight&quot;: &#123;
    &quot;fields&quot;: &#123;
      &quot;name&quot;: &#123;
        &quot;require_field_match&quot;: &quot;false&quot;
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
</li>
</ul>
<h2 id="RestClient查询文档"><a href="#RestClient查询文档" class="headerlink" title="RestClient查询文档"></a>RestClient查询文档</h2><p><strong>快速入门</strong></p>
<p>测试matchAll查询API</p>
<p><strong>步骤：</strong></p>
<p>1、创建SearchRequest对象</p>
<p>2、准备Request.source()，也就是DSL</p>
<p>​	QueryBuilders来构建查询条件</p>
<p>​	传入Request.source()的query()方法</p>
<p>3、发生请求得到结果</p>
<p>4、解析结果（参考JSON结果，从外到内，逐层解析）</p>
<p><strong>API：</strong></p>
<ul>
<li><strong>source()：</strong>封装了大量功能，查询，排序等</li>
<li><strong>QueryBuilders：</strong>封装了match，boolquery，range等查询</li>
</ul>
<pre><code class="java">@SpringBootTest
public class HotelSearchTest &#123;

    @Autowired
    private IHotelService hotelService;

    private RestHighLevelClient client;

    @BeforeEach
    void setUp()&#123;
        this.client = new RestHighLevelClient(RestClient.builder(
                HttpHost.create(&quot;http://192.168.119.88:9200&quot;)
        ));
    &#125;


    @AfterEach
    void tearDown() throws IOException &#123;
        this.client.close();
    &#125;



    @Test
    void testMatchAll() throws IOException&#123;

        //1、准备Request
        SearchRequest request = new SearchRequest(&quot;hotel&quot;);

        //2、组织DSL参数
        request.source().query(QueryBuilders.matchAllQuery());

        //3、发生请求，得到响应
        SearchResponse response = client.search(request,RequestOptions.DEFAULT);

        //打印JSON串
        //System.out.println(response);

        //4、解析响应
        SearchHits searchHits = response.getHits();

        //4.1、获取总条数
        long total = searchHits.getTotalHits().value;
        System.out.println(&quot;共搜索到&quot;+ total + &quot;条数据&quot;);

        //4.2、文档数组
        SearchHit[] hits = searchHits.getHits();

        //4.3、遍历
        for (SearchHit hit : hits) &#123;

            //获取文档source
            String json = hit.getSourceAsString();

            //反序列化对象
            HotelDoc hotelDoc = JSON.parseObject(json, HotelDoc.class);

            System.out.println(&quot;hotelDoc = &quot;+ hotelDoc);
        &#125;

    &#125;

&#125;
</code></pre>
<h3 id="全文检索查询-1"><a href="#全文检索查询-1" class="headerlink" title="全文检索查询"></a>全文检索查询</h3><p>全文检索查询的<strong>match</strong>和<strong>multi_match</strong>查询与match_all的API基本一致，差别就是查询条件，也就是<strong>query的部分</strong></p>
<pre><code class="java">//参数1：指定字段，参数2：查询的内容
QueryBuilders.matchQuery(&quot;all&quot;,&quot;如家&quot;);

//多字段查询，参数1：查询的内容，参数2，3...：指定字段
QueryBuilders.multiMatchQuery(&quot;如家&quot;,&quot;name&quot;,&quot;business&quot;)
</code></pre>
<h3 id="精确查询-1"><a href="#精确查询-1" class="headerlink" title="精确查询"></a>精确查询</h3><p>精确查询常见的有term查询和range查询，同样利用QueryBuilders实现</p>
<pre><code class="java">//词条查询
QueryBuilders.termQuery(&quot;city&quot;,&quot;杭州&quot;);

//范围查询
QueryBuilders.rangeQuery(&quot;price&quot;).gte(100).lte(150);
</code></pre>
<h3 id="复合查询-boolean-query"><a href="#复合查询-boolean-query" class="headerlink" title="复合查询-boolean query"></a>复合查询-boolean query</h3><pre><code class="java">//创建布尔查询
BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();

//添加must条件
boolQuery.must(QueryBuilders.termQuery(&quot;city&quot;,&quot;杭州&quot;));

//添加filter条件
boolQuery.filter(QueryBuilders.rangeQuery(&quot;price&quot;).lte(250));
</code></pre>
<p><strong>测试布尔查询</strong></p>
<pre><code class="java">@Test
void testBooleanQuery() throws IOException&#123;

    //1、准备Request
    SearchRequest request = new SearchRequest(&quot;hotel&quot;);

    //2、组织DSL参数
    request.source().query();

    //2.1准备BooleanQuery
    BoolQueryBuilder booleanQuery = QueryBuilders.boolQuery();

    //2.2添加term查询条件
    booleanQuery.must(QueryBuilders.termQuery(&quot;city&quot;,&quot;上海&quot;));

    //2.3添加range查询条件
    booleanQuery.filter(QueryBuilders.rangeQuery(&quot;price&quot;).lte(250));

    //构建查询请求
    request.source().query(booleanQuery);

    //3、发生请求，得到响应
    SearchResponse response = client.search(request,RequestOptions.DEFAULT);

    //打印JSON串
    //System.out.println(response);

    //解析响应
    HandleResponse(response);

&#125;
</code></pre>
<h3 id="排序和分页"><a href="#排序和分页" class="headerlink" title="排序和分页"></a>排序和分页</h3><p>搜索结果的排序和分页是与query同级的参数，对应的API如下：</p>
<pre><code class="java">@Test
void testOrderAndPage() throws IOException &#123;
    
    //页码，分页单位
    int page = 1,size = 5;

    SearchRequest request = new SearchRequest(&quot;hotel&quot;);

    //查询
    request.source().query(QueryBuilders.matchAllQuery());

    //分页
    request.source().from((page - 1) * size).size(size);

    //价格排序
    request.source().sort(&quot;price&quot;, SortOrder.ASC);

    SearchResponse response = client.search(request, RequestOptions.DEFAULT);

    handleResponse(response);

&#125;
</code></pre>
<p><strong>根据地理坐标排序</strong></p>
<pre><code class="java">request.source().sort(SortBuilders.geoDistanceSort(&quot;location&quot;,new GeoPoint(location))
        .unit(DistanceUnit.KILOMETERS)
        .order(SortOrder.ASC)
);
</code></pre>
<h3 id="高亮显示"><a href="#高亮显示" class="headerlink" title="高亮显示"></a>高亮显示</h3><p>高亮API包括请求DSL构建和结果解析两部分</p>
<pre><code class="java">@Test
    void testHighLight() throws IOException &#123;

        SearchRequest request = new SearchRequest(&quot;hotel&quot;);

        request.source().query(QueryBuilders.matchQuery(&quot;all&quot;,&quot;如家&quot;));

        request.source().highlighter(new HighlightBuilder()
                //需要高亮的字段名
                .field(&quot;name&quot;)
                //是否需要与查询字段匹配
                .requireFieldMatch(false)
        );

        SearchResponse response = client.search(request,RequestOptions.DEFAULT);

        SearchHit[] hits = response.getHits().getHits();

        for (SearchHit hit : hits) &#123;

            HotelDoc hotelDoc = JSON.parseObject(hit.getSourceAsString(), HotelDoc.class);

            //获取高亮结果属性集
            Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();

            if(!CollectionUtils.isEmpty(highlightFields))&#123;

                //根据字段获取高亮结果集
                HighlightField highlightField = highlightFields.get(&quot;name&quot;);

                if (highlightField != null)&#123;

                    //获取高亮结果
                    Text[] fragments = highlightField.getFragments();

                    //获取高亮值
                    String name = fragments[0].string();

                    //覆盖非高亮结果
                    hotelDoc.setName(name);

                &#125;

            &#125;

            System.out.println(&quot;hotelDoc = &quot;+ hotelDoc);

        &#125;

    &#125;
</code></pre>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以邮件至 1300452403@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">赏</a>
</p>


<div class="article_copyright">
    <p><span class="copy-title">文章标题:</span>ElasticSearch</p>
    <p><span class="copy-title">字数:</span><span class="post-count">8.6k</span></p>
    <p><span class="copy-title">本文作者:</span><a  title="Os467">Os467</a></p>
    <p><span class="copy-title">发布时间:</span>2022-09-04, 23:29:31</p>
    <p><span class="copy-title">最后更新:</span>2022-09-15, 00:00:36</p>
    <span class="copy-title">原始链接:</span><a class="post-url" href="/2022/09/04/ElasticSearch/" title="ElasticSearch">https://os467.github.io/2022/09/04/ElasticSearch/</a>
    <p>
        <span class="copy-title">版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">&#34;署名-非商用-相同方式共享 4.0&#34;</a> 转载请保留原文链接及作者。
    </p>
</div>





    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2016-2020 os467
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>喜欢就点赞,疼爱就打赏</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">支付宝</label></span><span><label><input type="radio" name="pay" value="weixin">微信</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
